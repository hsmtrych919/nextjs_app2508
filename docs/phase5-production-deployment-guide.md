# Phase 5.1 Cloudflareæœ¬ç•ªç’°å¢ƒè¨­å®š å®Ÿè¡Œã‚¬ã‚¤ãƒ‰

## ğŸš¨ é‡è¦: ã‚ãªãŸãŒå®Ÿè¡Œã™ã¹ãä½œæ¥­

ä»¥ä¸‹ã®ä½œæ¥­ã¯**Cloudflareã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ç®¡ç†è€…æ¨©é™**ãŒå¿…è¦ãªãŸã‚ã€ç§ï¼ˆAIï¼‰ã§ã¯å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚
**ã‚ãªãŸã”è‡ªèº«ã§å®Ÿè¡Œã—ã¦ã„ãŸã ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚**

---

## ğŸ“‹ äº‹å‰ç¢ºèª

### âœ… å®Œäº†æ¸ˆã¿é …ç›®ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒï¼‰
- ãƒ­ãƒ¼ã‚«ãƒ«D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: `satellite-investment-db` ä½œæˆæ¸ˆã¿
- ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã‚µãƒ¼ãƒãƒ¼: `wrangler pages dev` æ­£å¸¸å‹•ä½œ
- å…¨æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ: ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é¸æŠãƒ»éŠ˜æŸ„å…¥åŠ›ãƒ»è¨ˆç®—æ©Ÿèƒ½ å®Œå…¨å‹•ä½œç¢ºèªæ¸ˆã¿
- iPhone 12 Proã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: å®Œå…¨å¯¾å¿œæ¸ˆã¿

### âŒ æœªå®Ÿæ–½é …ç›®ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
- æœ¬ç•ªD1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆ
- æœ¬ç•ªPagesç’°å¢ƒè¨­å®š
- æœ¬ç•ªç’°å¢ƒå¤‰æ•°ãƒ»Secretsè¨­å®š
- æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤

---

## ğŸ¯ Step 1: Cloudflareèªè¨¼å†è¨­å®šã€5åˆ†ã€‘

### 1.1 Wranglerå†ãƒ­ã‚°ã‚¤ãƒ³
```bash
# ç¾åœ¨ã®èªè¨¼ã‚’ã‚¯ãƒªã‚¢
wrangler logout

# å†ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãŒé–‹ãã¾ã™ï¼‰
wrangler login
```

**æ‰‹é †:**
1. ãƒ–ãƒ©ã‚¦ã‚¶ã§Cloudflareã«ãƒ­ã‚°ã‚¤ãƒ³
2. ã€ŒWrangler CLIã‚’è¨±å¯ã—ã¾ã™ã‹ï¼Ÿã€â†’ **Allow**ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç¢ºèª

### 1.2 èªè¨¼ç¢ºèª
```bash
# ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ç¢ºèª
wrangler whoami

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸€è¦§ç¢ºèª
wrangler d1 list
```

**æœŸå¾…çµæœ:**
- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæƒ…å ±ãŒæ­£å¸¸è¡¨ç¤º
- ç¾åœ¨ã®ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ `satellite-investment-db` ãŒè¡¨ç¤º

---

## ğŸ¯ Step 2: æœ¬ç•ªD1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆã€10åˆ†ã€‘

### 2.1 æœ¬ç•ªç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆ
```bash
# æœ¬ç•ªç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆ
wrangler d1 create satellite-investment-db-prod
```

**é‡è¦:** ä½œæˆå¾Œã«è¡¨ç¤ºã•ã‚Œã‚‹**Database ID**ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚
```
âœ… Successfully created D1 database!

ğŸ“‹ Database Details
Name: satellite-investment-db-prod
UUID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx  â† ã“ã‚Œã‚’ã‚³ãƒ”ãƒ¼
```

### 2.2 æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDç¢ºèª
```bash
# ä½œæˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¸€è¦§ã§UUIDç¢ºèª
wrangler d1 list
```

**é‡è¦:** `satellite-investment-db-prod` ã®UUIDã‚’Step 4.3ã§ä½¿ç”¨ã—ã¾ã™ã€‚

### 2.3 æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
```bash
# æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
wrangler d1 execute satellite-investment-db-prod --file=./db/migrations/0001_initial.sql --env=production
```

### 2.4 æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ç¢ºèª
```bash
# ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆç¢ºèª
wrangler d1 execute satellite-investment-db-prod --command="SELECT name FROM sqlite_master WHERE type='table';" --env=production
```

**æœŸå¾…çµæœ:**
```
settings
budget
holdings
formation_usage
formation_history
```

---

## ğŸ¯ Step 3: Cloudflare Pagesæœ¬ç•ªç’°å¢ƒä½œæˆã€15åˆ†ã€‘

### 3.1 Pages ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ
```bash
# Pagesãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒ»åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤
npm run build
wrangler pages deploy _dist --project-name=satellite-investment-app
```

**æ‰‹é †:**
1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: `satellite-investment-app`
2. åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Ÿè¡Œã•ã‚Œã¾ã™
3. å®Œäº†å¾Œã«URLï¼ˆä¾‹: `https://xxxxxxxx.satellite-investment-app.pages.dev`ï¼‰ãŒè¡¨ç¤º

### 3.2 ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ç¢ºèª
ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾Œã€ä»¥ä¸‹ã®ã‚ˆã†ãªæœ¬ç•ªURLãŒè¡¨ç¤ºã•ã‚Œã¾ã™:
```
âœ… Deployment complete!
URL: https://xxxxxxxx.satellite-investment-app.pages.dev
```

ã“ã®URLã¯Step 6.2ã®å‹•ä½œç¢ºèªã§ä½¿ç”¨ã—ã¾ã™ã€‚

---

## ğŸ¯ Step 4: æœ¬ç•ªç’°å¢ƒå¤‰æ•°ãƒ»Secretsè¨­å®šã€10åˆ†ã€‘

### 4.1 Cloudflare Dashboardè¨­å®š

**Cloudflare Dashboardï¼ˆhttps://dash.cloudflare.comï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹:**

1. **Workers & Pages** â†’ **satellite-investment-app** ã‚’é¸æŠ
2. **Settings** â†’ **Environment variables** â†’ **Production** ã‚¿ãƒ–

### 4.2 ç’°å¢ƒå¤‰æ•°è¨­å®šï¼ˆProductionï¼‰
ä»¥ä¸‹ã‚’è¿½åŠ :
```
ENVIRONMENT = production
DEBUG_MODE = false
LOG_LEVEL = warn
API_VERSION = 1.0.0
APP_NAME = Satellite Investment Manager
TYPE_SYSTEM_VERSION = 1.3.0
```

### 4.3 Secretsè¨­å®šï¼ˆæ©Ÿå¯†æƒ…å ±ï¼‰
**Settings** â†’ **Secrets and Variables** â†’ **Production**ã§ä»¥ä¸‹ã‚’è¨­å®š:

```bash
# ã¾ãšDatabase UUIDã‚’ç¢ºèª
wrangler d1 list

# è¡¨ç¤ºã•ã‚ŒãŸ satellite-investment-db-prod ã®UUIDã‚’
# Cloudflare Dashboardã®Secretsã«è¨­å®š:
# Variable name: PROD_DATABASE_ID
# Value: [ä¸Šè¨˜ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªã—ãŸUUID]
```

### 4.4 Functions bindingè¨­å®š
**Settings** â†’ **Functions** â†’ **D1 database bindings**:
```
Variable name: DB
D1 database: satellite-investment-db-prod
```

---

## ğŸ¯ Step 5: Cron Triggersè¨­å®šã€5åˆ†ã€‘

### 5.1 Cronè¨­å®šç¢ºèª
```bash
# Cronè¨­å®šçŠ¶æ³ç¢ºèª
wrangler pages list
```

### 5.2 å¿…è¦ã«å¿œã˜ã¦Cronæ‰‹å‹•è¨­å®š
Cloudflare Dashboardã§ç¢ºèª:
- **Workers & Pages** â†’ **satellite-investment-app** â†’ **Scheduled Events**
- è¨­å®š: `0 5 * * *` (æ¯æ—¥åˆå‰5æ™‚JST)

---

## ğŸ¯ Step 6: æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»å‹•ä½œç¢ºèªã€15åˆ†ã€‘

### 6.1 æœ€æ–°ã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
```bash
# æœ€æ–°ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
npm run build
wrangler pages deploy _dist --project-name=satellite-investment-app --env=production
```

### 6.2 æœ¬ç•ªç’°å¢ƒå‹•ä½œç¢ºèª

**Step 3.2ã§è¨˜éŒ²ã—ãŸæœ¬ç•ªURLã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ç¢ºèª:**

#### 6.2.1 åŸºæœ¬æ©Ÿèƒ½ç¢ºèª
- [ ] ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿æ­£å¸¸
- [ ] ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é¸æŠå‹•ä½œ
- [ ] Tieråˆ¥éŠ˜æŸ„å…¥åŠ›è¡¨ç¤º
- [ ] æŠ•è³‡äºˆç®—ç®¡ç†æ©Ÿèƒ½

#### 6.2.2 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª
- [ ] ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é¸æŠâ†’ãƒ‡ãƒ¼ã‚¿ä¿å­˜
- [ ] éŠ˜æŸ„å…¥åŠ›â†’ãƒ‡ãƒ¼ã‚¿ä¿å­˜
- [ ] ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰â†’ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ

#### 6.2.3 è¨ˆç®—æ©Ÿèƒ½ç¢ºèª
- [ ] Goalæ ªæ•°è‡ªå‹•è¨ˆç®—
- [ ] Hold/Goalè¡¨ç¤º
- [ ] åˆ©å›ã‚Šè‡ªå‹•è¨ˆç®—

### 6.3 æœ¬ç•ªAPIå‹•ä½œç¢ºèª
```bash
# æœ¬ç•ªAPIãƒ†ã‚¹ãƒˆï¼ˆURLã‚’å®Ÿéš›ã®ã‚‚ã®ã«å¤‰æ›´ï¼‰
curl https://[ã‚ãªãŸã®æœ¬ç•ªURL]/api/data
```

**æœŸå¾…çµæœ:** JSONå½¢å¼ã§ãƒ‡ãƒ¼ã‚¿ãŒè¿”ã•ã‚Œã‚‹

---

## ğŸ¯ Step 7: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»æœ€çµ‚è¨­å®šã€10åˆ†ã€‘

### 7.1 wrangler.toml ã®ã‚»ã‚­ãƒ¥ã‚¢åŒ–
**é‡è¦:** ç¾åœ¨ã®`wrangler.toml`ã«ã‚ã‚‹ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ã®Database IDã‚’å‰Šé™¤

```toml
# ä»¥ä¸‹ã®è¡Œã‚’ç·¨é›†:
database_id = "31102c68-1cd7-4696-862f-2a115724f331"  # â† ã“ã‚Œã‚’å‰Šé™¤
â†“
database_id = ""  # ç©ºæ–‡å­—ã«ã—ã¦ã‚»ã‚­ãƒ¥ã‚¢åŒ–
```

### 7.2 Custom Domainè¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
ç‹¬è‡ªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ:
- Cloudflare Dashboard â†’ **Custom domains**ã§è¨­å®š

### 7.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ç¢ºèª
æœ¬ç•ªURLã§ä»¥ä¸‹ã‚’ç¢ºèª:
- HTTPSæ¥ç¶š
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼é©ç”¨çŠ¶æ³

---

## âœ… å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 5.1 æœ¬ç•ªç’°å¢ƒè¨­å®š
- [ ] Wranglerèªè¨¼æˆåŠŸï¼ˆ`wrangler whoami`ï¼‰
- [ ] æœ¬ç•ªD1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆãƒ»ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†
- [ ] Cloudflare Pages ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆãƒ»åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
- [ ] æœ¬ç•ªç’°å¢ƒå¤‰æ•°ãƒ»Secretsè¨­å®šå®Œäº†
- [ ] D1 bindingè¨­å®šå®Œäº†
- [ ] Cron Triggersè¨­å®šç¢ºèª
- [ ] æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»å…¨æ©Ÿèƒ½å‹•ä½œç¢ºèªå®Œäº†
- [ ] wrangler.toml ã‚»ã‚­ãƒ¥ã‚¢åŒ–å®Œäº†

### æ©Ÿèƒ½å‹•ä½œç¢ºèª
- [ ] ãƒ•ã‚©ãƒ¼ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é¸æŠã‚·ã‚¹ãƒ†ãƒ 
- [ ] Tieråˆ¥éŠ˜æŸ„å…¥åŠ›ãƒ»Goalè¨ˆç®—
- [ ] æŠ•è³‡äºˆç®—ç®¡ç†ãƒ»åˆ©å›ã‚Šè¨ˆç®—
- [ ] ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»è‡ªå‹•ä¿å­˜æ©Ÿèƒ½
- [ ] iPhone 12 Proè¡¨ç¤ºå¯¾å¿œ

---

## ğŸš¨ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºæ–¹æ³•

#### å•é¡Œ1: `wrangler login`å¤±æ•—
```bash
wrangler logout
wrangler login --browser=false
# è¡¨ç¤ºã•ã‚Œã‚‹URLã‚’æ‰‹å‹•ã§ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã
```

#### å•é¡Œ2: Database bindingèªè­˜ã—ãªã„
- Cloudflare Dashboard â†’ Functions â†’ D1 database bindings ã‚’å†ç¢ºèª
- Variable name: `DB`
- Database: `satellite-investment-db-prod`

#### å•é¡Œ3: æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã§ã‚¨ãƒ©ãƒ¼
```bash
# è©³ç´°ãƒ­ã‚°ç¢ºèª
wrangler pages deploy _dist --project-name=satellite-investment-app --compatibility-date=2025-08-10
```

#### å•é¡Œ4: ãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œãªã„
- Secretsè¨­å®šç¢ºèª: `PROD_DATABASE_ID`
- D1 bindingç¢ºèª
- ãƒ–ãƒ©ã‚¦ã‚¶é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã§API ã‚¨ãƒ©ãƒ¼ç¢ºèª

---

## ğŸ“ ã‚µãƒãƒ¼ãƒˆ

ä½œæ¥­ä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆ:
1. ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ­£ç¢ºã«ã‚³ãƒ”ãƒ¼
2. å®Ÿè¡Œã—ãŸã‚³ãƒãƒ³ãƒ‰ã‚’è¨˜éŒ²
3. Cloudflare Dashboardã®è¨­å®šç”»é¢ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ
4. ç§ï¼ˆAIï¼‰ã«è©³ç´°ã‚’ãŠä¼ãˆãã ã•ã„

---

**âš ï¸ é‡è¦äº‹é …:**
- ã“ã®ä½œæ¥­ã¯**æœ¬ç•ªç’°å¢ƒ**ã«å½±éŸ¿ã—ã¾ã™
- å„ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ…é‡ã«å®Ÿè¡Œã—ã¦ãã ã•ã„
- ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ä¸­æ–­ã—ã¦ç›¸è«‡ã—ã¦ãã ã•ã„
- å…¨ã¦ã®è¨­å®šæƒ…å ±ã¯æ©Ÿå¯†ã¨ã—ã¦ç®¡ç†ã—ã¦ãã ã•ã„

**ğŸ¯ ç›®æ¨™:** æœ¬ç•ªç’°å¢ƒã§ã‚µãƒ†ãƒ©ã‚¤ãƒˆæŠ•è³‡ç®¡ç†ã‚¢ãƒ—ãƒªãŒå®Œå…¨å‹•ä½œã™ã‚‹ã“ã¨
